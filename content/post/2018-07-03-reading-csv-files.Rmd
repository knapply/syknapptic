---
title: 'Reading .csv Files'
draft: false
author: Brendan Knapp
date: '2018-07-04'
slug: reading-csv-files
categories:
  - data-science-from-scratch
tags: 
  - benchmarking
  - fileIO
thumbnailImage: http://i0.kym-cdn.com/photos/images/facebook/001/124/028/5c2.jpg
metaAlignment: center
coverMeta: out
summary: Comparing performance of R and Python in reading .csv files to data frames.
output:
  html_document:
  # blogdown::html_page:
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 11, fig.height = 10,
                      fig.align = "center",
                      message = FALSE, warning = FALSE)

knitr::knit_engines$set(python = reticulate::eng_python)
```

```{r}
library(bench)
library(kableExtra); options(knitr.kable.NA = "")
library(reticulate); use_condaenv("r-reticulate", required = TRUE)
library(scales)
library(tidyverse)
```

# The Data

The initial .csv was obtained from [Majestic Million CSV](https://blog.majestic.com/development/majestic-million-csv-daily/) [<img src="https://licensebuttons.net/l/by/3.0/88x31.png">](https://creativecommons.org/licenses/by/3.0/deed.en_US).

```{r, eval=FALSE}
file_url <- "http://downloads.majestic.com/majestic_million.csv"
temp_file <- tempfile(fileext = ".csv")

download.file(file_url, destfile = temp_file)

test_df <- read_csv(temp_file)
```

```{r, echo=FALSE}
path <- "test-data/majestic_million.csv"
test_df <- read_csv(path)
```

#### Quick Inspection

```{r}
glimpse(test_df)

test_df

test_df %>%                          # 0 NAs anywhere
  summarise_all(funs(sum(is.na(.))))
```

```{r, eval=FALSE}
write_csv(test_df, path)
```

## Small 

```{r}
small_df <- test_df %>% 
  slice(1:100)

small_df
(small_rows <- nrow(small_df)) %>% comma() %>% paste("rows")

path_small_csv <- "test-data/small_csv.csv"
write_csv(small_df, path_small_csv)
```

## Medium

```{r}
medium_df <- test_df %>% 
  slice(1:5000)

medium_df
(med_rows <- nrow(medium_df ))%>% comma() %>% paste("rows")

path_medium_csv <- "test-data/medium_csv.csv"
write_csv(medium_df, path_medium_csv)
```

## Big

```{r}
big_df <- test_df %>% 
  rerun(.n = 5) %>% 
  bind_rows()

(big_rows <- nrow(big_df)) %>% comma() %>% paste("rows")

path_big_csv <- "test-data/big_csv.csv"
write_csv(big_df, path_big_csv)
```

# The Code

The following steps were taken to "standardize" code.

* R and Python functions:
    1. File paths are assigned to a `"*_csv.csv"` variable.
    2. The column data types are identified ahead of time via a `*_col_specs` variable.
        + All "numeric" data are read as `double` via:
            + `"double"` for `utils::read.csv()` and `data.table::fread()` 
            + `readr::col_double()` for `readr::read_csv()`
            + `float` for `pandas.read_csv()`
        + This is to standardize numeric usage as my understanding is that both R's `double`s and Python's `float`s are `double`s in the underlying C code.
    3. The function assigns the result to an internal `df` variable.
    4. The function explicitly `return()`s the data frame.
* .R and .py scripts:
    1. Relevant package are loaded via R's `library()` or Python's `import`.
    2. File paths are assigned to a `"*_csv.csv"` variable.
    3. The column data types are identified ahead of time via a `*_col_specs` variable.
        + All "numeric" data are read as `double`s.
    4. Data frames are assigned to a variable upon reading the file.
    
```{r}
inspect_script <- function(path) {
  contents <- read_lines(path)
  cat("```\n")
  cat("# ", path, " ", rep("=", (80 - nchar(path) - 2)), "\n", sep = "")
  contents %>% walk(cat, "\n")
  cat("```\n\n")
}
```

## R

### "Base" - `utils::read.csv()`

#### Local `knitr` Function

```{r}
base_col_specs <- c("double", "double", "character",
                    "character", "double", "double",
                    "character", "character", "double",
                    "double", "double", "double")

base_test <- function(path) {
  df <- read.csv(file = path, colClasses = base_col_specs)
  
  return(df)
}
```

#### Scripts to Source via System Calls

```{r, results='asis'}
base_files <- c("r/base_test_small.R", "r/base_test_med.R", "r/base_test_big.R")

base_files %>% 
  walk(inspect_script)
```

### `readr::read_csv()`

#### Local `knitr` Function

```{r}
library(readr)

readr_col_specs <- list(col_integer(), col_integer(), col_character(),
                        col_character(), col_integer(), col_integer(),
                        col_character(), col_character(), col_integer(),
                        col_integer(), col_integer(), col_integer())

readr_test <- function(path) {
  df <- read_csv(file = path, col_types = readr_col_specs)
  
  return(df)
}
```

#### Scripts to Source via System Calls

```{r, results='asis'}
readr_files <- c("r/readr_test_small.R", "r/readr_test_med.R", "r/readr_test_big.R") 

readr_files %>% 
  walk(inspect_script)
```

### `data.table::fread()`

#### Local `knitr` Function

```{r}
library(data.table)

datatable_col_specs <- c("double", "double", "character",
                         "character", "double", "double",
                         "character", "character", "double",
                         "double", "double", "double")

datatable_test <- function(path) {
  df <- fread(file = path, colClasses = datatable_col_specs)
  
  return(df)
}
```

#### Scripts to Source via System Calls

```{r, results='asis'}
datatable_files <- c("r/datatable_test_small.R", "r/datatable_test_med.R",
                     "r/datatable_test_big.R") 

datatable_files %>% 
  walk(inspect_script)
```

## Python

### `pandas.read_csv()`

#### Local `knitr` Function

```{python, cache = FALSE}
import pandas

path_small_csv = 'test-data/small_csv.csv'
path_medium_csv = 'test-data/medium_csv.csv'
path_big_csv = 'test-data/big_csv.csv'

pandas_col_specs = {
  'GlobalRank':float, 'TldRank':float, 'Domain':str,
  'TLD':str, 'RefSubNets':float, 'RefIPs':float,
  'IDN_Domain':str, 'IDN_TLD':str, 'PrevGlobalRank':float,
  'PrevTldRank':float, 'PrevRefSubNets':float, 'PrevRefIPs':float
  }

def pandas_test_small():
  df = pandas.read_csv(filepath_or_buffer = path_small_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)
  
def pandas_test_medium():
  df = pandas.read_csv(filepath_or_buffer = path_medium_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)
  
def pandas_test_big():
  df = pandas.read_csv(filepath_or_buffer = path_big_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)
```

#### Scripts to Source via System Calls

```{r, results='asis'}
pandas_files <- c("py/pandas_test_small.py", "py/pandas_test_med.py",
                  "py/pandas_test_big.py")

pandas_files %>% 
  walk(inspect_script)
```

#### `reticulate::py_run_string("pandas.read_csv(...)"", convert = FALSE)`

```{r}
py_run_string(
"
import pandas

path_small_csv = 'test-data/small_csv.csv'
path_medium_csv = 'test-data/medium_csv.csv'
path_big_csv = 'test-data/big_csv.csv'

pandas_col_specs = {
  'GlobalRank':float, 'TldRank':float, 'Domain':str,
  'TLD':str, 'RefSubNets':float, 'RefIPs':float,
  'IDN_Domain':str, 'IDN_TLD':str, 'PrevGlobalRank':float,
  'PrevTldRank':float, 'PrevRefSubNets':float, 'PrevRefIPs':float
  }

def retic_pandas_test_small():
  df = pandas.read_csv(filepath_or_buffer = path_small_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)

def retic_pandas_test_medium():
  df = pandas.read_csv(filepath_or_buffer = path_medium_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)

def retic_pandas_test_big():
  df = pandas.read_csv(filepath_or_buffer = path_big_csv,
                dtype = pandas_col_specs, low_memory = False)
  return(df)
", convert = FALSE
)
```

# The Test

```{r}
n_iterations <- 100
```

```{r, eval=FALSE}
results <- mark(
  base_test(path_small_csv),
  readr_test(path_small_csv),
  datatable_test(path_small_csv),
  system("Rscript r/base_test_small.R"),
  system("Rscript r/readr_test_small.R"),
  system("Rscript r/datatable_test_small.R"),
  
  py$pandas_test_small(),
  py_run_string("retic_pandas_test_small()"),
  system("python py/pandas_test_small.py"),

  base_test(path_medium_csv),
  readr_test(path_medium_csv),
  datatable_test(path_medium_csv),
  system("Rscript r/base_test_med.R"),
  system("Rscript r/readr_test_med.R"),
  system("Rscript r/datatable_test_med.R"),
  
  py$pandas_test_medium(),
  py_run_string("retic_pandas_test_medium()"),
  system("python py/pandas_test_med.py"),

  base_test(path_big_csv),
  readr_test(path_big_csv),
  datatable_test(path_big_csv),
  system("Rscript r/base_test_big.R"),
  system("Rscript r/readr_test_big.R"),
  system("Rscript r/datatable_test_big.R"),

  py$pandas_test_big(),
  py_run_string("retic_pandas_test_big()"),
  system("python py/pandas_test_big.py"),

  check = FALSE, filter_gc = FALSE, iterations = n_iterations
  )
```

```{r, eval=FALSE, echo=FALSE}
write_rds(results, "test-data/read-csv-test-results.rds")
```

```{r, echo=FALSE}
results <- read_rds("test-data/read-csv-test-results.rds")
```

# The Results

```{r}
all_exprs <- results$expression
system_calls <- all_exprs %>% str_subset("^system\\(")
local_r_fun_calls <- all_exprs %>% str_subset("^(base|readr|datatable)_test\\(")
python_eng_calls <- all_exprs %>% str_subset("^py\\$")
reticulate_calls <- all_exprs %>% str_subset("retic_")
knitr_calls <- c(local_r_fun_calls, python_eng_calls, reticulate_calls)

results_df <- results %>%
  unnest() %>%
  mutate(call = case_when(
    str_detect(expression, "base") ~ "utils::read.csv()",
    str_detect(expression, "readr") ~ "readr::read_csv()",
    str_detect(expression, "datatable") ~ "data.table::fread()",
    str_detect(expression, "py_run") ~ "reticulate::py_run_string()",
    str_detect(expression, "pandas") ~ "pandas.read_csv()"
      ) %>%
      str_pad(max(nchar(.)), side = "right") # enforce alignment in plots
    ) %>%
  mutate(execution_type = case_when(
    expression %in% system_calls ~ "Sourced Script",
    expression %in% knitr_calls ~ "knitr Engine"
    )) %>%
  mutate(lang = if_else(str_detect(expression, "pandas"), "Python", "R")) %>%
  mutate(file_size = str_extract(expression, "small|med|big")) %>%
  mutate(rows = case_when(
    file_size == "small" ~ small_rows,
    file_size == "med" ~ med_rows,
    file_size == "big" ~ big_rows
    ))

gg_df <- results_df %>%
  arrange(rows) %>%
  mutate(rows = rows %>%
           comma() %>%
           paste("Rows") %>%
           as_factor()
        ) %>%
  group_by(expression) %>% 
  mutate(med_time = as.numeric(median(time))) %>% 
  ungroup() %>% 
  arrange(desc(med_time)) %>%
  mutate(call = as_factor(call)) %>%
  arrange(desc(lang)) %>%
  mutate(lang = as_factor(lang))
```

```{r}
results_df %>%
  select(rows, lang, call, everything(), -expression, -n_itr,
         -time, -gc, -file_size, -min, -max, -total_time, -starts_with("level")) %>%
  distinct() %>% 
  arrange(rows, desc(lang)) %>%
  rename(garbage_collections = n_gc, language = lang,
         memory_allocated = mem_alloc) %>%
  rename_all(funs(str_to_title(str_replace(., "_", " ")))) %>%
  kable(digits = 2) %>%
  kable_styling(bootstrap_options = "condensed", font_size = 12) %>% 
  collapse_rows(columns = 1:2, valign = "top")
```

```{r}
plot_times <- function(df, plot_title = NULL) {
  plot_init <- df %>% 
    ggplot(aes(call, time, fill = lang, color = lang)) +
    stat_ydensity(scale = "width") +
    scale_fill_manual(values = c("#165CAA", "#ffde57"), 
                      labels = function(x) paste(" ", x, "  ")) +
    scale_color_manual(values = c("#BFC2C5", "#4584b6"),
                       labels = function(x) paste(" ", x, "  ")) +
    guides(fill = guide_legend(nrow = 1)) +
    coord_flip() +
    theme_minimal(17, "serif") +
    theme(legend.title = element_blank(), 
          legend.position = "top",
          legend.key.size = unit(1.5, "lines"),
          axis.text.y = element_text("mono", face = "bold", hjust = 0),
          plot.caption = element_text(size = 10))
  if(length(plot_title)) {
    plot_fin <- plot_init + 
      facet_wrap(~ rows, nrow = 3, scales = "free_x") +
      labs(x = NULL, y = "Time",
         title = plot_title,
         caption = str_glue("{n_iterations} runs per call."))
  } else {
    n_rows <- sort(df$rows, decreasing = TRUE)[[1]]
    plot_fin <- plot_init + 
      facet_wrap(~ execution_type, ncol = 1, scales = "free") +
      labs(x = NULL, y = "Time", title = str_glue("CSV to Data Frame: {comma(n_rows)}"),
           caption = str_glue("{n_iterations} runs per call."))
  }
  
  plot_fin
}
```

## Code Executed by `knitr`'s Language Engine

```{r}
gg_df %>% 
  filter(execution_type == "knitr Engine") %>% 
  plot_times("knitr Engine")
```


## Files Sourced via System Command

```{r}
gg_df %>% 
  filter(execution_type == "Sourced Script") %>% 
  plot_times("Files Sourced via System Command")
```

# tl;dr

```{r}
gg_df %>%
  filter(file_size == "small") %>%
  plot_times()

gg_df %>%
  filter(file_size == "med") %>% 
  plot_times()

gg_df %>%
  filter(file_size == "big") %>% 
  plot_times()
```

# Session Info

## R

```{r}
sessionInfo()
```

## Python

```{python}
import sys
import numpy
import pandas  

print(sys.version)
print(numpy.__version__)
print(pandas.__version__)
```



